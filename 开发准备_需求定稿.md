# 飞书文档导出工具：需求定稿与开发准备

## 1. 目标与范围（MVP）
本项目交付一个 CLI 工具，将飞书 `Docs/Wiki` 导出为：
1. `Markdown`（可阅读主内容）
2. `DocAST(JSON)`（结构化中间层）
3. `assets`（图片、表格 CSV 等）

MVP 仅支持 `Docs + Wiki`，不支持 `Bitable` 与独立 `Spreadsheet`。

## 2. 核心原则
1. 语义还原优先于视觉还原。
2. 不追求严格可逆回写，但必须可定位（保留 `doc_id/block_id/asset_id/source_url`）。
3. 先有 `DocAST`，再渲染 `Markdown`，避免渲染阶段抹平层级。

## 3. CLI 与输出契约
命令：
1. `export-doc --doc <doc_url_or_id> --out <dir>`
2. `export-wiki --wiki <wiki_url_or_id> --out <dir> --recursive`

输出结构：
1. `docs/<doc_id>/index.md`
2. `docs/<doc_id>/docast.json`
3. `docs/<doc_id>/sources.json`
4. `docs/<doc_id>/assets/images/*`
5. `docs/<doc_id>/assets/tables/*`

## 4. 内容支持清单（MVP）
必须支持：
1. Heading、Paragraph、Quote/Callout、Code block、Divider
2. 多级有序/无序/混合列表（层级不丢）
3. 普通表格 -> Markdown table
4. 图片下载并在 `index.md` 引用
5. `image-digest` 占位块（先 mock，不强依赖多模态模型）

允许降级：
1. 复杂样式（颜色、字号、对齐）
2. 画板/流程图先落 `SVG/PNG + digest`，Mermaid 可选

## 5. 技术方案定稿
1. 技术栈：TypeScript + Node.js + ESM
2. CLI：`commander`（或 `yargs`，二选一）
3. 数据校验：`zod` 定义 `DocAST Schema`
4. 鉴权：`FEISHU_APP_ID` + `FEISHU_APP_SECRET` 获取并缓存 token，处理过期刷新
5. 渲染：`DocAST -> Markdown` 单向 renderer

## 6. 验收标准
人工验收（抽检）：
1. 标题与列表层级语义正确
2. 图片、表格、链接不丢
3. 大表格在 md 可截断，但 CSV 存在且可追溯

自动验收（CI）：
1. `docast.json` 通过 zod 校验
2. md 中引用资源文件存在
3. 列表层级渲染单测通过
4. 表格导出与 `sources.json` 记录单测通过

## 7. 里程碑（建议）
1. Phase 0（1-2 天）：token + 拉取单 doc + 最小 md + 图片下载
2. Phase 1（2-4 天）：DocAST 完整化 + 渲染器 + 单测
3. Phase 2（1-2 天）：image-digest 命令与 mock captioner
4. Phase 3（后续）：Wiki 批量、增量同步、Mermaid 增强

## 8. 开发前置事项
1. 立即旋转已暴露的 `App Secret`，并改用本地环境变量注入。
2. 确认目标区域域名（`open.larkoffice.com` / `open.larksuite.com`）与租户一致。
3. 准备 5-10 篇真实样本文档作为回归基准集。
